/*! nice Validator 0.4.0
 * (c) 2012-2013 Jony Zhang <zj86@live.cn>, MIT Licensed
 * http://niceue.com/validator/
 */
!function(e,t){"use strict";function i(a,s){var l,u,o=this;return!o instanceof i?new i(a,s):(N(s)&&(s={valid:s}),s=s||{},s.valid&&(o.isAjaxSubmit=!0),u=X(a,"data-"+p+"-option"),u=u&&"{"===u.charAt(0)?Function("return "+u)():{},l=Q[s.theme||u.theme||J.theme],o.options=e.extend({},J,l,u,s),o.$el=e(a),o.rules=new n(o.options.rules,!0),o.messages=new r(o.options.messages,!0),o.elements={},o.fields={},o.isValid=!0,o.deferred={},o._init(),t)}function n(e,t){var i=t?t===!0?this:t:n.prototype;if(L(e))for(var r in e)i[r]=a(e[r])}function r(e,t){var i=t?t===!0?this:t:r.prototype;if(L(e))for(var n in e){if(!e[n])return;i[n]=e[n]}}function a(t){switch(e.type(t)){case"function":return t;case"array":return function(e){return t[0].test(e.value)||t[1]||!1};case"regexp":return function(e){return t.test(e.value)}}}function s(t){var i="";return e.map(t.split(" "),function(e){i+=","+("#"===e.charAt(0)?e:'[name="'+e+'"]')}),i.substring(1)}function l(t){if(t&&t.tagName){var i=t;switch(t.tagName){case"INPUT":case"SELECT":case"TEXTAREA":i=t.form||e(t).closest(".n-"+p);break;default:i=e(t).closest(".n-"+p)}return e(i).data(p)||e(i)[p]().data(p)}}function u(i,n){var r=e.trim(X(i,x+"-"+n));if(r)return r=Function("return "+r)(),r?a(r):t}function o(e,t,i){var n=t.msg;return L(n)&&i&&(n=n[i]),I(n)||(n=X(e,"data-msg-"+i)||X(e,"data-msg")||""),n}function d(e){if(!e)return"";var t=S.exec(e);return t?t[1]:""}function c(e){return(e||J.msgTemplate).replace("{#msg}",V)}function f(t,i,n){var r,a,s,l,u=e(t);if(u.is(":input")?(l=i.target||X(t,O),l&&(l=e(l,n),l.length&&(l.is(":input")?t=l.get(0):r=l)),a=t.name||"#"+t.id,r=r||e("."+_+'[data-for="'+a+'"]',n)):r=u,!r.length)if(u=e(l||t,n),s=c(i.tpl),r=e(s).addClass(_).attr({style:i.style||"","data-for":a}),i.cls&&r.addClass(i.cls),u.is(":checkbox,:radio")){var o=u.parent();r.appendTo(o.is("label")?o.parent():o)}else r[i.pos&&"right"!==i.pos?"insertBefore":"insertAfter"](u);return r}function g(t,i,n){var r,a,s;r={error:v,ok:h,tip:y,loading:b}[i.type||(i.type="error")],a=f(t,i,n),s=a.find("span.msg-wrap"),s.length||(s=e(V).appendTo(a)),P&&-1!==a[0].className.indexOf("bottom")&&(a[0].style.marginTop=e(t).outerHeight()+"px"),s[0].innerHTML=(i.arrow||"")+(i.icon||"")+'<span class="n-msg">'+i.msg+"</span>",s[0].className="msg-wrap "+r,a[0].style.display="",N(i.show)&&i.show.call(n,s,i.type)}function m(e,t,i){t=t||{};var n=f(e,t,i);n.length&&(N(t.hide)?(n[0].style.display="",t.hide.call(i,n.find("span.msg-wrap"),t.type)):n[0].style.display="none")}var p="validator",h="n-ok",v="n-error",y="n-tip",b="n-loading",k="n-invalid",_="msg-box",w="aria-invalid",x="data-rule",O="data-target",M="data-tip",$="data-inputstatus",A="novalidate",R=":input:not(:button,:submit,:reset,:disabled)",V='<span class="msg-wrap" role="alert"></span>',T=/(\w+)(?:\[(.*)\]$|\((.*)\)$)?/,j=/(?:([^:]*):)?(.*)/,C=/[^\x00-\xff]/g,S=/^.*(top|right|bottom|left).*$/,E=/(?:(post|get):)?(.+)/i,F=/<|>/g,q=e.noop,H=e.proxy,N=e.isFunction,D=e.isArray,I=function(e){return"string"==typeof e},L=function(e){return e&&"[object Object]"===Object.prototype.toString.call(e)},P=!window.XMLHttpRequest,X=function(e,i,n){return n===t?e.getAttribute(i):(null===n?e.removeAttribute(i):e.setAttribute(i,""+n),t)},B=window.console||{log:q,info:q,warn:q},J={debug:0,timely:1,theme:"default",stopOnError:!0,ignore:"",valid:q,invalid:q,msgTemplate:"<span>{#msg}</span>",msgIcon:'<span class="n-icon"></span>',msgArrow:"",msgClass:"",defaultMsg:"{0} is not valid.",loadingMsg:"Validating..."},Q={"default":{formClass:"n-default",msgClass:"n-right",showOk:""}};e.fn[p]=function(t){var n=this,r=arguments;return n.is(":input")?n:(!n.is("form")&&(n=this.find("form")),!n.length&&(n=this),n.each(function(){if(I(t)){if("_"===t.charAt(0))return;var n=e(this).data(p);n&&n[t].apply(n,Array.prototype.slice.call(r,1))}else new i(this,t)}),this)},e.fn.isValid=function(e,i){var n,r=l(this[0]);return r?(i===t&&(i=!0),r.checkOnly=i,n=this.is(":input")?this:this.find(R),r._multiValidate(n,function(t){N(e)&&e.call(null,t),r.checkOnly=!1},!0)):!0},i.prototype={_init:function(){var t=this,i=t.options,n=t.fields;D(i.groups)&&e.map(i.groups,function(i){if(!I(i.fields)||!N(i.callback))return null;var r=e(s(i.fields),t.$el),a=function(){return i.callback.call(t,r)};e.extend(a,i),e.map(i.fields.split(" "),function(e){n[e]=n[e]||{},n[e].group=a})}),L(i.fields)&&e.each(i.fields,function(e,t){t&&(n[e]=I(t)?{rule:t}:t)}),e(R,t.$el).each(function(){t._parse(this)}),t.msgOpt={type:"error",tpl:c(i.msgTemplate),pos:d(i.msgClass),cls:i.msgClass,icon:i.msgIcon,arrow:i.msgArrow,style:i.msgStyle,show:i.msgShow,hide:i.msgHide},t.$el.data(p)||(t.$el.on("submit validate",H(t,"_submit")).on("reset",H(t,"_reset")).on("validated.field",R,H(t,"_validatedField")).on("validated.rule",R,H(t,"_validatedRule")).on("focusout validate",R,H(t,"_blur")).on("click",":radio,:checkbox",H(t,"_click")),i.msgHandler||t.$el.on("focusin click",R,H(t,"_focus")),i.timely>=2&&t.$el.on("keyup",R,H(t,"_blur")).on("change","select",H(t,"_click")),t.$el.data(p,t).addClass("n-"+p+" "+i.formClass),X(t.$el[0],A,!0))},_multiValidate:function(i,n,r){var a=this,s=a.options;return s.ignore&&(i=i.not(s.ignore)),a.isValid=!0,a.deferred={},i.each(function(e,i){var n=a.getField(i);if(n)return a._validate(i,n,r),!a.isValid&&s.stopOnError?!1:t}),e.when.apply(null,e.map(a.deferred,function(e){return e})).done(function(){if(n.call(a,a.isValid),N(s.msgHandler)){var t=[];e.map(a.fields,function(e){e.errorMsg&&t.push(e.errorMsg)}),s.msgHandler.call(a,t)}}),e.isEmptyObject(a.deferred)?a.isValid:t},_submit:function(i,n){var r=this;if(r.submiting&&"only"!==n)return N(r.submiting)&&r.submiting.call(r),i.preventDefault();if(!("only"===n||"validate"===i.type&&e(i.target).is(":not(form)"))){var a,s=r.options,l=i.target,u="focus.field",o=e(R,r.$el);if(r._reset(),r.submiting=!0,r.isAjaxSubmit===t)if(null===X(l,"action"))r.isAjaxSubmit=!0;else{var d=e[e._data?"_data":"data"](r.$el[0],"events");r.isAjaxSubmit=d&&d.valid&&e.map(d.valid,function(e){return"form"===e.namespace?1:null}).length?!0:!1}return r._multiValidate(o,function(t){if(t)r.isAjaxSubmit||e(l).trigger("submit",["only"]);else{var i=r.$el.find(":input."+k+":first");i.trigger(u),P&&i.trigger(u)}r.submiting=!1,a=t||2===s.debug?"valid":"invalid",s[a].call(r,l),r.$el.trigger(a+".form",[l])},!0),(r.isAjaxSubmit||!e.isEmptyObject(r.deferred))&&i.preventDefault(),r.isValid}},_reset:function(){var t=this;t.options.msgHandler||(e("[data-for]."+_,t.$el).each(function(){this.style.display="none"}),e(R,t.$el).each(function(){X(this,$,null),X(this,w,null),e(this).removeClass(k)})),t.isValid=!0},_focus:function(e){var t=e.target;this.submiting||""!==t.value&&("false"===X(t,w)||"tip"===X(t,$))||this.showMsg(t,{msg:X(t,M),type:"tip"})},_blur:function(t,i){var n,r,a=this,s=a.options,l=t.target,u=100;if(!i){if("validate"===t.type)r=!0;else{if(X(l,"notimely"))return;if(s.timely>=2&&"keyup"!==t.type)return}if(s.ignore&&e(l).is(s.ignore))return;if("keyup"===t.type){var o=t.keyCode,d={8:1,9:1,16:1,32:1,46:1};if(9===o&&!l.value)return;if(48>o&&!d[o])return;u=s.timely>=100?s.timely:500}}n=a.getField(l),n&&(n.timeout&&clearTimeout(n.timeout),n.timeout=setTimeout(function(){a._validate(l,n,r)},u))},_click:function(e){this._blur(e,!0)},_parse:function(e){var i,n=this,r=e.name;return(e.id&&"#"+e.id in n.fields||!e.name)&&(r="#"+e.id),r?(i=n.fields[r]||{},i.rule||(i.rule=X(e,x)||""),X(e,x,null),i.rule&&(i.name=i.name||e.name,i.key=r,i.required=-1!==i.rule.indexOf("required"),i.must=i.must||-1!==i.rule.indexOf("match")||-1!==i.rule.indexOf("checked"),i.required&&X(e,"aria-required",!0),("timely"in i&&!i.timely||!n.options.timely)&&X(e,"notimely",!0),I(i.target)&&X(e,O,i.target),I(i.tip)&&X(e,M,i.tip),n.fields[r]=n._parseRule(i)),t):X(e,x,null)},_parseRule:function(i){var n,r=j.exec(i.rule);if(r)return i.display=r[1],i.rules=[],n=(r[2]||"").split(";"),e.map(n,function(n){var r=T.exec(n);return r?(r[3]&&(r[2]=r[3]),i.rules.push({method:r[1],params:r[2]?e.trim(r[2]).split(", "):t}),t):null}),i.vid=0,i.rid=i.rules[0].method,i},_validatedField:function(t,i,n){var r=this,a=r.options,s=t.target,l=i.isValid=!!n.valid;l&&(n.type="ok"),e(s)[l?"removeClass":"addClass"](k).trigger((l?"valid":"invalid")+".field",[i,n]).attr(w,!l),i.old.ret=n,r.elements[i.key]=s,a.msgHandler?i.errorMsg=l?"":n.msg:r.checkOnly||(!n.showOk&&n.msg||n.showOk&&a.showOk!==!1?r.showMsg(s,n):r.hideMsg(s,n))},_validatedRule:function(i,n,r,a){r=r||s.getField(u);var s=this,l=s.options,u=i.target,d="",c=r.rid,f=!1,g=!1;if(a=a||{},n===!0||n===t?f=!0:(d=o(u,r,c),d||(I(n)?(d=n,n={error:d}):L(n)&&(n.error?d=n.error:(f=!0,n.ok&&I(n.ok)&&(g=!0),d=n.ok))),a.msg=(f?d:d||s.messages[c]||J.defaultMsg).replace("{0}",r.display||"")),f){if(a.valid=!0,!g){var m=r.ok||X(u,"data-ok");m?(g=!0,a.msg=m):I(l.showOk)&&(g=!0,a.msg=l.showOk)}a.showOk=g,e(u).trigger("valid.rule",[c])}else s.isValid=!1,e(u).trigger("invalid.rule",[c]);l.debug&&B[f?"info":"warn"](r.vid+": "+c+" -> "+(a.msg||!0)),f&&r.old.value!==t&&r.old.value!==u.value?(r.vid=0,s._checkRule(u,r)):f&&r.vid<r.rules.length-1?(r.vid++,s._checkRule(u,r)):(r.vid=0,e(u).trigger("validated.field",[r,a]))},_checkRule:function(i,n){var r,a=this,s=n.key,l=n.rules[n.vid],o=l.method,d=l.params;if(!a.submiting||!a.deferred[s])if(n.rid=o,n.old.value=i.value,r=(u(i,o)||a.rules[o]||function(){return!0}).call(a,i,d,n),L(r)&&N(r.then)){var c=function(e){return I(e)||L(e)&&("error"in e||"ok"in e)?e:t};a.deferred[s]=r,!a.checkOnly&&a.showMsg(i,{type:"loading",msg:a.options.loadingMsg}),r.then(function(r,a,s){var l,u=s.responseText;""===u?u=!0:"{"===u.charAt(0)&&(u=e.parseJSON(u)||{},l=c(u),l===t&&(l=c(u.data)),u=l||!0),e(i).trigger("validated.rule",[u,n])},function(t,r){e(i).trigger("validated.rule",[r,n])}),n.isValid=t}else e(i).trigger("validated.rule",[r,n])},_validate:function(i,n,r){if(n.rules||this._parse(i),!i.disabled&&!X(i,A)){var a,s,l=this,u=l.options,o=e(i),d={},c=n.group,f="tip"===X(i,$),g=n.isValid=!0;if(a=n.old=n.old||{},r=r||n.must,c&&(e.extend(d,c),s=c.call(l),s!==!0?(I(s)&&(s={error:s}),n.vid=0,n.rid="group",g=!1):(s=t,l.hideMsg(i,d))),g&&!n.required&&""===i.value){if(f)return;if(l._focus({target:i}),a.value="",!o.is(":checkbox,:radio"))return o.trigger("validated.field",[n,{valid:!0}]),t}else if(!r&&a&&a.ret!==t&&a.value===i.value){if(a.ret.valid||(l.isValid=!1),f)return;if(""!==i.value)return d=a.ret,o.trigger("validated.field",[n,d]),t}u.debug&&B.log(i),s!==t?o.trigger("validated.rule",[s,n,d]):n.rule&&l._checkRule(i,n)}},_getMsgOpt:function(t){return e.extend({},this.msgOpt,I(t)?{msg:t}:t)},getField:function(e){var t,i=this;return t=e.id&&"#"+e.id in i.fields||!e.name?"#"+e.id:e.name,X(e,x)&&i._parse(e),i.fields[t]},test:function(i,n){var r,a,s,l=this,u=T.exec(n);return u?(u[3]&&(u[2]=u[3]),a=u[1],s=u[2]?e.trim(u[2]).split(", "):t,a in l.rules&&(r=l.rules[a].call(l,i,s)),r===!0||r===t||r):!0},getRangeMsg:function(e,t,i,n){if(t){var r=this,a=r.messages[i]||"",s=t[0].split("~"),l=s[0],u=s[1],o="rg",d=[""],c=+e===+e;if(2===s.length){if(l&&u){if(c&&e>=+l&&+u>=e)return!0;d=d.concat(s)}else if(l&&!u){if(c&&e>=+l)return!0;d.push(l),o="gt"}else if(!l&&u){if(c&&+u>=e)return!0;d.push(u),o="lt"}}else{if(e===+l)return!0;d.push(l),o="eq"}return a&&(n&&n+o in a&&(o=n+o),d[0]=a[o]),r.renderMsg.apply(null,d)}},renderMsg:function(){var e=arguments,t=e[0],i=e.length;if(t){for(;--i;)t=t.replace("{"+i+"}",e[i]);return t}},showMsg:function(t,i){i=this._getMsgOpt(i),(i.msg||i.showOk)&&(t=e(t).get(0),X(t,$,i.type),g(t,i,this.$el))},hideMsg:function(t,i){i=this._getMsgOpt(i),m(e(t).get(0),i,this.$el)},mapMsg:function(t){var i=this;e.each(t,function(t,n){var r=i.elements[t]||e(':input[name="'+t+'"]',i.$el)[0];i.showMsg(r,n)})},setMsg:function(e){new r(e,this.messages)},setRule:function(t){new n(t,this.rules),e.map(this.fields,function(e){e.old={}})},setField:function(i,n){var r=this,a={};if(I(i)){if(null===n)return e.map(i.split(" "),function(e){e&&r.fields[e]&&(r.fields[e]=null)}),t;n&&(a[i]=n)}else L(i)&&(a=i);r.options.fields?e.extend(r.options.fields,a):r.options.fields=a,r._init()},holdSubmit:function(e){e===t&&(e=!0),this.submiting=e},destroy:function(){this._reset(),this.$el.off().removeData(p)}},e(function(){e("body").on("focusin",":input["+x+"]",function(){var t=this,i=l(t);i?(X(t,x)&&i._parse(t),e(t).trigger("focusin")):X(t,x,null)}).on("click submit","form:not([novalidate])",function(t){var i,n=e(this);n.data(p)||(i=n[p]().data(p),e.isEmptyObject(i.fields)?(X(this,A,!0),n.removeData(p)):"submit"===t.type&&i._submit(t))})}),new n({required:function(t){return!!e.trim(t.value)},integer:function(e,t){var i,n="0|",r="[1-9]\\d*",a=t?t[0]:"*";switch(a){case"+":i=r;break;case"-":i="-"+r;break;case"+0":i=n+r;break;case"-0":i=n+"-"+r;break;default:i=n+"-?"+r}return i="^(?:"+i+")$",RegExp(i).test(e.value)||this.messages.integer[a]},match:function(t,i,n){var r,a,s,l,u,o=t.value,d="eq";if(i&&(1===i.length?a=i[0]:(d=i[0],a=i[1]),l=e("#"===a.charAt(0)?a:':input[name="'+a+'"]',this.$el)[0]))switch(n.init_match||(this.$el.on("valid.field",'[name="'+a+'"]',function(){t.value&&e(t).trigger("validate")}),n.init_match=!0),u=this.getField(l),s=this.messages.match[d].replace("{1}",u.display||a),r=l.value,d){case"lt":return+r>+o||s;case"lte":return+r>=+o||s;case"gte":return+o>=+r||s;case"gt":return+o>+r||s;default:return o===r||s}},range:function(e,t){return this.getRangeMsg(+e.value,t,"range")},checked:function(t,i){if(!e(t).is(":radio,:checkbox"))return!0;var n=e('input[name="'+t.name+'"]',this.$el).filter(function(){return!this.disabled&&this.checked&&e(this).is(":visible")}).length;return i?this.getRangeMsg(n,i,"checked"):!!n||this.messages.required},length:function(e,t){var i=e.value,n=(t[1]?i.replace(C,"xx"):i).length;return t&&"~"===t[0].charAt(0)&&(t[0]="0"+t[0]),this.getRangeMsg(n,t,"length",t[1]?"2_":"")},remote:function(t,i){var n,r=this,a={};return i?(n=E.exec(i[0]),a[t.name]=t.value,i[1]&&e.map(i.slice(1),function(t){a[t]=e(':input[name="'+t+'"]',r.$el).val()}),e.ajax({url:n[2],async:!0,type:n[1]||"POST",data:a,cache:!1})):!0},filter:function(e,t){var i=t?RegExp("["+t[0]+"]","g"):F;return e.value=e.value.replace(i,""),!0}}),i.setTheme=function(t,i){L(t)?e.each(t,function(e,t){Q[e]=t}):I(t)&&L(i)&&(Q[t]=i)},i.config=function(t){e.each(t,function(e,t){"rules"===e?new n(t):"messages"===e?new r(t):J[e]=t})},e[p]=i}(jQuery);
